'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.run = run;
var nearley = require('nearley');
var grammar = require('./grammar');
var interp = require('./interp');
var chalk = require('chalk');

function run(code, dir) {
  var parser = new nearley.Parser(grammar.ParserRules, grammar.ParserStart);
  var asts = void 0;

  try {
    asts = parser.feed(code).results;
  } catch (e) {
    // there's been a syntax error :(

    var line = 1;
    var lines = code.split('\n');
    lines.unshift('');
    for (var i = 0; i < e.offset; i++) {
      var char = code[i];
      if (char == '\n') line++;
    }

    var ln = lines[line];

    if (line - 1 > 0) console.log(chalk.bold(line - 1), lines[line - 1]);
    if (line) console.log(chalk.bold(line), chalk.red(ln));
    if (line + 1 < lines.length) console.log(chalk.bold(line + 1), lines[line + 1]);
    console.error(chalk.red('\nSyntax Error at ' + chalk.cyan('line ' + line) + '!'));

    process.exit(1);
  }

  if (asts.length > 1) {
    console.warn(chalk.red.bold('!! AMBIGUOUS SYNTAX !!'));
    var _escape = String.fromCharCode(27);
    asts.forEach(function (ast, i) {
      console.warn(JSON.stringify(ast, null, 0));
      console.warn('\n----------------------------\n');
    }) - console.warn(chalk.yellow('\nA total of ' + chalk.cyan(asts.length) + ' ASTs were generated.\nPlease report this on the official issue tracker:\nhttps://github.com/liam4/tlnccuwagnf/issues\nUsing first AST.\n'));
  }

  var result = interp.interp(asts[0], dir);
  return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJ1bi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztRQUtnQjtBQUxoQixJQUFNLFVBQVUsUUFBUSxTQUFSLENBQVY7QUFDTixJQUFNLFVBQVUsUUFBUSxXQUFSLENBQVY7QUFDTixJQUFNLFNBQVMsUUFBUSxVQUFSLENBQVQ7QUFDTixJQUFNLFFBQVEsUUFBUSxPQUFSLENBQVI7O0FBRUMsU0FBUyxHQUFULENBQWEsSUFBYixFQUFtQixHQUFuQixFQUF3QjtBQUM3QixNQUFJLFNBQVMsSUFBSSxRQUFRLE1BQVIsQ0FBZSxRQUFRLFdBQVIsRUFBcUIsUUFBUSxXQUFSLENBQWpELENBRHlCO0FBRTdCLE1BQUksYUFBSixDQUY2Qjs7QUFJN0IsTUFBSTtBQUNGLFdBQU8sT0FBTyxJQUFQLENBQVksSUFBWixFQUFrQixPQUFsQixDQURMO0dBQUosQ0FFRSxPQUFPLENBQVAsRUFBVTs7O0FBR1YsUUFBSSxPQUFPLENBQVAsQ0FITTtBQUlWLFFBQUksUUFBUSxLQUFLLEtBQUwsQ0FBVyxJQUFYLENBQVIsQ0FKTTtBQUtWLFVBQU0sT0FBTixDQUFjLEVBQWQsRUFMVTtBQU1WLFNBQUssSUFBSSxJQUFJLENBQUosRUFBTyxJQUFJLEVBQUUsTUFBRixFQUFVLEdBQTlCLEVBQW1DO0FBQ2pDLFVBQUksT0FBTyxLQUFLLENBQUwsQ0FBUCxDQUQ2QjtBQUVqQyxVQUFJLFFBQVEsSUFBUixFQUFjLE9BQWxCO0tBRkY7O0FBS0EsUUFBSSxLQUFLLE1BQU0sSUFBTixDQUFMLENBWE07O0FBYVYsUUFBSSxPQUFPLENBQVAsR0FBVyxDQUFYLEVBQWMsUUFBUSxHQUFSLENBQVksTUFBTSxJQUFOLENBQVcsT0FBTyxDQUFQLENBQXZCLEVBQWtDLE1BQU0sT0FBTyxDQUFQLENBQXhDLEVBQWxCO0FBQ0EsUUFBSSxJQUFKLEVBQVUsUUFBUSxHQUFSLENBQVksTUFBTSxJQUFOLENBQVcsSUFBWCxDQUFaLEVBQThCLE1BQU0sR0FBTixDQUFVLEVBQVYsQ0FBOUIsRUFBVjtBQUNBLFFBQUksT0FBTyxDQUFQLEdBQVcsTUFBTSxNQUFOLEVBQWMsUUFBUSxHQUFSLENBQVksTUFBTSxJQUFOLENBQVcsT0FBTyxDQUFQLENBQXZCLEVBQWtDLE1BQU0sT0FBTyxDQUFQLENBQXhDLEVBQTdCO0FBQ0EsWUFBUSxLQUFSLENBQWMsTUFBTSxHQUFOLHdCQUErQixNQUFNLElBQU4sV0FBbUIsSUFBbkIsT0FBL0IsQ0FBZCxFQWhCVTs7QUFrQlYsWUFBUSxJQUFSLENBQWEsQ0FBYixFQWxCVTtHQUFWOztBQXFCRixNQUFJLEtBQUssTUFBTCxHQUFjLENBQWQsRUFBaUI7QUFDbkIsWUFBUSxJQUFSLENBQWEsTUFBTSxHQUFOLENBQVUsSUFBVixDQUFlLHdCQUFmLENBQWIsRUFEbUI7QUFFbkIsUUFBSSxVQUFTLE9BQU8sWUFBUCxDQUFvQixFQUFwQixDQUFULENBRmU7QUFHbkIsU0FBSyxPQUFMLENBQWEsVUFBUyxHQUFULEVBQWMsQ0FBZCxFQUFpQjtBQUM1QixjQUFRLElBQVIsQ0FBYSxLQUFLLFNBQUwsQ0FBZSxHQUFmLEVBQW9CLElBQXBCLEVBQTBCLENBQTFCLENBQWIsRUFENEI7QUFFNUIsY0FBUSxJQUFSLENBQWEsa0NBQWIsRUFGNEI7S0FBakIsQ0FBYixHQUlBLFFBQVEsSUFBUixDQUFhLE1BQU0sTUFBTixtQkFDSixNQUFNLElBQU4sQ0FBVyxLQUFLLE1BQUwsK0lBRFAsQ0FBYixDQUpBLENBSG1CO0dBQXJCOztBQWVBLE1BQUksU0FBUyxPQUFPLE1BQVAsQ0FBYyxLQUFLLENBQUwsQ0FBZCxFQUF1QixHQUF2QixDQUFULENBMUN5QjtBQTJDN0IsU0FBTyxNQUFQLENBM0M2QjtDQUF4QiIsImZpbGUiOiJydW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBuZWFybGV5ID0gcmVxdWlyZSgnbmVhcmxleScpXG5jb25zdCBncmFtbWFyID0gcmVxdWlyZSgnLi9ncmFtbWFyJylcbmNvbnN0IGludGVycCA9IHJlcXVpcmUoJy4vaW50ZXJwJylcbmNvbnN0IGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuKGNvZGUsIGRpcikge1xuICBsZXQgcGFyc2VyID0gbmV3IG5lYXJsZXkuUGFyc2VyKGdyYW1tYXIuUGFyc2VyUnVsZXMsIGdyYW1tYXIuUGFyc2VyU3RhcnQpXG4gIGxldCBhc3RzXG5cbiAgdHJ5IHtcbiAgICBhc3RzID0gcGFyc2VyLmZlZWQoY29kZSkucmVzdWx0c1xuICB9IGNhdGNoIChlKSB7XG4gICAgLy8gdGhlcmUncyBiZWVuIGEgc3ludGF4IGVycm9yIDooXG5cbiAgICBsZXQgbGluZSA9IDFcbiAgICBsZXQgbGluZXMgPSBjb2RlLnNwbGl0KCdcXG4nKVxuICAgIGxpbmVzLnVuc2hpZnQoJycpXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlLm9mZnNldDsgaSsrKSB7XG4gICAgICBsZXQgY2hhciA9IGNvZGVbaV1cbiAgICAgIGlmIChjaGFyID09ICdcXG4nKSBsaW5lKytcbiAgICB9XG5cbiAgICBsZXQgbG4gPSBsaW5lc1tsaW5lXVxuXG4gICAgaWYgKGxpbmUgLSAxID4gMCkgY29uc29sZS5sb2coY2hhbGsuYm9sZChsaW5lIC0gMSksIGxpbmVzW2xpbmUgLSAxXSlcbiAgICBpZiAobGluZSkgY29uc29sZS5sb2coY2hhbGsuYm9sZChsaW5lKSwgY2hhbGsucmVkKGxuKSlcbiAgICBpZiAobGluZSArIDEgPCBsaW5lcy5sZW5ndGgpIGNvbnNvbGUubG9nKGNoYWxrLmJvbGQobGluZSArIDEpLCBsaW5lc1tsaW5lICsgMV0pXG4gICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFxcblN5bnRheCBFcnJvciBhdCAke2NoYWxrLmN5YW4oYGxpbmUgJHtsaW5lfWApfSFgKSlcblxuICAgIHByb2Nlc3MuZXhpdCgxKVxuICB9XG5cbiAgaWYgKGFzdHMubGVuZ3RoID4gMSkge1xuICAgIGNvbnNvbGUud2FybihjaGFsay5yZWQuYm9sZCgnISEgQU1CSUdVT1VTIFNZTlRBWCAhIScpKVxuICAgIGxldCBlc2NhcGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDI3KVxuICAgIGFzdHMuZm9yRWFjaChmdW5jdGlvbihhc3QsIGkpIHtcbiAgICAgIGNvbnNvbGUud2FybihKU09OLnN0cmluZ2lmeShhc3QsIG51bGwsIDApKVxuICAgICAgY29uc29sZS53YXJuKCdcXG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXFxuJylcbiAgICB9KS1cbiAgICBjb25zb2xlLndhcm4oY2hhbGsueWVsbG93KGBcbkEgdG90YWwgb2YgJHtjaGFsay5jeWFuKGFzdHMubGVuZ3RoKX0gQVNUcyB3ZXJlIGdlbmVyYXRlZC5cblBsZWFzZSByZXBvcnQgdGhpcyBvbiB0aGUgb2ZmaWNpYWwgaXNzdWUgdHJhY2tlcjpcbmh0dHBzOi8vZ2l0aHViLmNvbS9saWFtNC90bG5jY3V3YWduZi9pc3N1ZXNcblVzaW5nIGZpcnN0IEFTVC5cbmApKVxuICB9XG5cbiAgbGV0IHJlc3VsdCA9IGludGVycC5pbnRlcnAoYXN0c1swXSwgZGlyKVxuICByZXR1cm4gcmVzdWx0XG59XG4iXX0=